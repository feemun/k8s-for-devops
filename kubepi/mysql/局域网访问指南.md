# MySQL 局域网访问指南

## 当前部署状态
✅ MySQL 已成功部署在 Kubernetes 集群中  
✅ NodePort 服务已配置，端口：30306  
✅ 端口转发已启用：0.0.0.0:30306 -> MySQL Service  
✅ 服务器局域网 IP 地址：192.168.1.102  

## 连接信息

### 服务器信息
- **主机地址**: 192.168.1.102
- **端口**: 30306
- **数据库**: testdb

### 用户账户
1. **管理员账户**
   - 用户名: root
   - 密码: mysql123
   - 权限: 完全管理权限

2. **普通用户账户**
   - 用户名: testuser
   - 密码: userpass
   - 权限: testdb 数据库访问权限

## 局域网其他机器连接方法

### 1. 使用 MySQL 命令行客户端

#### 安装 MySQL 客户端
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install mysql-client

# CentOS/RHEL
sudo yum install mysql

# macOS (使用 Homebrew)
brew install mysql-client
```

#### 连接命令
```bash
# 使用 root 用户连接
mysql -h 192.168.1.102 -P 30306 -u root -pmysql123

# 使用 testuser 连接到 testdb
mysql -h 192.168.1.102 -P 30306 -u testuser -puserpass testdb
```

### 2. 使用图形化工具

#### MySQL Workbench
1. 下载并安装 MySQL Workbench
2. 创建新连接：
   - Connection Name: K8s MySQL
   - Hostname: 192.168.1.102
   - Port: 30306
   - Username: root 或 testuser
   - Password: mysql123 或 userpass

#### phpMyAdmin (Web 界面)
如需 Web 界面访问，可以部署 phpMyAdmin：
```bash
# 在 K8s 集群中部署 phpMyAdmin (可选)
kubectl create deployment phpmyadmin --image=phpmyadmin/phpmyadmin
kubectl set env deployment/phpmyadmin PMA_HOST=mysql-service.mysql.svc.cluster.local
kubectl expose deployment phpmyadmin --type=NodePort --port=80
```

#### Navicat
1. 打开 Navicat
2. 新建连接 → MySQL
3. 填写连接信息：
   - 主机: 192.168.1.102
   - 端口: 30306
   - 用户名: root 或 testuser
   - 密码: mysql123 或 userpass

### 3. 编程语言连接示例

#### Python (使用 PyMySQL)
```python
import pymysql

# 连接配置
config = {
    'host': '192.168.1.102',
    'port': 30306,
    'user': 'testuser',
    'password': 'userpass',
    'database': 'testdb',
    'charset': 'utf8mb4'
}

# 建立连接
connection = pymysql.connect(**config)
cursor = connection.cursor()

# 执行查询
cursor.execute("SELECT VERSION()")
result = cursor.fetchone()
print(f"MySQL 版本: {result[0]}")

# 关闭连接
cursor.close()
connection.close()
```

#### Java (使用 JDBC)
```java
import java.sql.*;

public class MySQLConnection {
    public static void main(String[] args) {
        String url = "jdbc:mysql://192.168.1.102:30306/testdb";
        String username = "testuser";
        String password = "userpass";
        
        try {
            Connection connection = DriverManager.getConnection(url, username, password);
            Statement statement = connection.createStatement();
            ResultSet resultSet = statement.executeQuery("SELECT VERSION()");
            
            if (resultSet.next()) {
                System.out.println("MySQL 版本: " + resultSet.getString(1));
            }
            
            connection.close();
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }
}
```

#### Node.js (使用 mysql2)
```javascript
const mysql = require('mysql2');

const connection = mysql.createConnection({
    host: '192.168.1.102',
    port: 30306,
    user: 'testuser',
    password: 'userpass',
    database: 'testdb'
});

connection.connect((err) => {
    if (err) {
        console.error('连接失败: ' + err.stack);
        return;
    }
    console.log('已连接，连接ID: ' + connection.threadId);
});

connection.query('SELECT VERSION()', (error, results, fields) => {
    if (error) throw error;
    console.log('MySQL 版本:', results[0]['VERSION()']);
});

connection.end();
```

## 网络要求

### 防火墙设置
确保局域网中的机器可以访问 Minikube 主机的 30306 端口：

```bash
# 在 Minikube 主机上检查防火墙状态
sudo ufw status

# 如果需要，开放 30306 端口
sudo ufw allow 30306
```

### 网络连通性测试
在其他机器上测试连通性：
```bash
# 测试端口是否可达
telnet 192.168.1.102 30306

# 或使用 nc (netcat)
nc -zv 192.168.1.102 30306
```

## 故障排除

### 常见问题

1. **连接被拒绝**
   - 检查 Minikube 是否运行：`minikube status`
   - 检查 MySQL Pod 状态：`kubectl get pods -n mysql`
   - 检查服务状态：`kubectl get svc -n mysql`

2. **认证失败**
   - 确认用户名和密码正确
   - 检查用户权限：`kubectl exec -it <mysql-pod> -n mysql -- mysql -u root -pmysql123 -e "SELECT user,host FROM mysql.user;"`

3. **网络不通**
   - 检查防火墙设置
   - 确认服务器局域网 IP 地址：192.168.1.102
   - 确保端口转发正在运行：`kubectl port-forward --address 0.0.0.0 service/mysql-nodeport 30306:3306 -n mysql`
   - 测试端口连通性：`telnet 192.168.1.102 30306`

### 查看日志
```bash
# 查看 MySQL Pod 日志
kubectl logs -f <mysql-pod-name> -n mysql

# 查看服务详情
kubectl describe svc mysql-nodeport -n mysql
```

## 安全建议

1. **生产环境注意事项**
   - 更改默认密码
   - 限制 root 用户远程访问
   - 使用 SSL/TLS 加密连接
   - 配置适当的防火墙规则

2. **用户权限管理**
   - 为不同应用创建专用数据库用户
   - 遵循最小权限原则
   - 定期审查用户权限

---

**注意**: 此配置适用于开发和测试环境。生产环境请考虑使用 LoadBalancer 或 Ingress 等更安全的暴露方式。